LUD-21: Facilitate fiat to fiat transactions over the lightning network
===============================

This LUD extends [LUD-06](https://github.com/lnurl/luds/blob/luds/06.md) to facilitate fiat-to-fiat transactions over the lightning network by including optional metadata and parameters. `targetExchangeData` and `sourceExchangeData` are additional pieces of data that will be returned from the existing requests. `amount` and `currency` are optional query parameters that can be used to determine the fiat requirements for the transaction.

There are two potential scenarios...
- The sender sets the fiat amount and currency they want to send. 
- The sender sets the fiat amount and currency they want the recipient to receive. 

### Scenario one
Someone wants to send 10 GBP to the USA and credit the target account in USD.

- The `WALLET` makes a request following the [`payRequest`](https://github.com/lnurl/luds/blob/luds/06.md) spec, including extra information about the desired target fiat currency as a query parameter.
- The `SERVICE` then decides if it can fulfil such exchange and returns `targetExchangeData` in case it can, including a promised price of exchange and an expiry for the promise.
- The `WALLET` shows the price back to the user along with it's own price exchange information, indicating how much USD would arrive at `SERVICE` for 10 GBP.
- Upon confirmation, `WALLET` performs the exchange from GBP, calls the `SERVICE` back on the callback URL passing as a query parameter, along the sats amount bought, the `sourceExchangeData`, including the price related to the exchange and the currency.
- The `SERVICE` then generates the invoice that, when paid, will be converted into USD, completing the fiat-to-fiat transfer.

### Scenario two
Someone wants to send exactly 10 USD to the USA from their GBP enabled wallet.

- The `WALLET` makes a request following the [`payRequest`](https://github.com/lnurl/luds/blob/luds/06.md) spec, including extra information about the desired target fiat currency and amount as a query parameter.
- The `SERVICE` then decides if it can fulfil such exchange and returns `targetExchangeData` in case it can, including a promised price of exchange, an expiry for the promise, and a bolt11 invoice.
- The `WALLET` shows the price back to the user along with it's own price exchange information, indicating how much BTC is required for the user to receive 10 USD.
- Upon confirmation, `WALLET` performs the exchange from GBP and pays the bolt11 invoice, calls the `SERVICE` back on the callback URL including the `sourceExchangeData` as a query parameter (this includes the data related to the exchange and currency from the `WALLET`).


### Wallet to service interaction:
1. User scans a LNURL QR code or pastes/shares an `lightning:LNURL..` link with `LN WALLET` and `LN WALLET` decodes LNURL. The decoded LNURL contains a comma separated list of `LN SERVICE` supported currencies on the end.\
    `?currency=GBP,EUR,USD`
2. `LN WALLET` makes a GET request to `LN SERVICE` using the decoded LNURL replacing the comma separated list of currencies with the one required for the transaction, also an optional `amount` query parameter can be added to indicate the fiat amount the end recipient should receive. (If `amount` is not included then a lightning invoice will not be returned in the first request)\
    `?currency=USD`
3. `LN WALLET` gets JSON response from `LN SERVICE` of form:

    ```Typescript
    {
        "callback": string, // The URL from LN SERVICE which will accept the pay request parameters.
        "maxSendable": number, // Max millisatoshi amount LN SERVICE is willing to receive.
        "minSendable": number, // Min millisatoshi amount LN SERVICE is willing to receive, can not be less than 1 or more than `maxSendable`.
        "metadata": string, // Metadata json which must be presented as raw string here, this is required to pass signature verification at a later step.
        "tag": "payRequest", // Type of LNURL.
        "targetExchangeData": {
            "id": string, // The transaction identifier generated by the LN SERVICE.
            "currency": string, // The currency (ISO 4217) passed as query, as confirmation that it is accepted.
            "price": number,  // The sell price promised for the received Bitcoin in given currency.
            "expiry": number, // The unix timestamp of when the fx rate will expire.
            "fee": number, // (Optional) The fee charged by the LN SERVICE in the chosen currency.
            "pr": string // (Optional) If an amount was specified then return a bolt11 invoice with the required BTC amount.
        }
    }
    ```

    If `SERVICE` supports `LUD-21` and cannot perform the exchange, then an error must be returned.
    If `SERVICE` returns a payload without `targetExchangeData`, it must be because it doesn't support `LUD-21`.

3. `LN WALLET` displays a payment dialog where user can specify an amount in the fiat currency supported by the wallet:

    ```
    max can send = min(maxSendable, local estimation of how much sats the given amount is)
    min can send = max(minSendable, local minimal value allowed by wallet)
    ```

    Additionally, the wallet is able to show how much target currency the given amount would be exchanged into.
    The amount of target fiat currency received would be calculated as follows:
        `amount / sourceExchangeData.price * targetExchangeData.price`

4. Upon user confirmation, `LN WALLET` buys the sats and makes a GET request using

    ```
    <callback><?|&>amount=<milliSatoshi><?|&>sourceExchangeData=<urlencode({json object})>
    ```

    `amount` being the amount of milisats to be sent after successful conversion.

    `sourceExchangeData` being an optional parameter with the following format

    ```Typescript
    {
        "currency": string, // The currency the Bitcoin was bought with.
        "price": number, // The price paid to buy the Bitcoin in the source currency.
    }
    ```

    If omitted, the `SERVICE` performs the conversion without knowing the source currency.
    If provided, the `SERVICE` is able to provide richer information about the conversion flow.

5. `LN Service` takes the GET request and returns JSON response of form:

    ```Typescript
    {
        pr: string, // bech32-serialized lightning invoice
        routes: [] // an empty array
    }
    ```

6. `LN WALLET` Verifies that `h` tag in provided invoice is a hash of `metadata` string converted to byte array in UTF-8 encoding.
7. `LN WALLET` Verifies that amount in provided invoice equals the amount previously specified by user.
8. `LN WALLET` pays the invoice, no additional user confirmation is required at this point.
9. `LN SERVICE` receives the payment and automatically converts the BTC into the currency `LN WALLET` specified when making the `payRequest`, crediting the `LN SERVICE` user in fiat, not in BTC.
